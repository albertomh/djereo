<!-- markdownlint-disable MD033 no-inline-html -->
# Djereo's features

`djereo` is a Django project template with opinionated tooling.

When invoked by following the instructions in the [Quickstart](./quickstart.md) the user
is prompted to answer questions and make choices via a CLI. These answers are used to
create a ready-to-use opinionated Django project.

This page documents the features of a Django project as generated by `djereo`.

## <img src="https://simpleicons.org/icons/ticktick.svg" width="25" alt="Checkmark icon"> Setup questionnaire

[copier.yaml](https://github.com/albertomh/djereo/blob/main/copier.yaml){target=\"_blank"}
defines the questionnaire that `copier` will use to prompt the user when setting up a new
project. The questions defined in this file include sensible defaults (where appropriate)
and validation rules to prevent incoherent answers.

### Versions

Users are asked three version-related questions when initialising a project:

#### Django version

[Django](https://docs.djangoproject.com/en/stable/){target=\"_blank"} is a popular web
framework written in Python. `djereo` gives you the choice between creating projects using
Django versions:

- 5.1 (latest)
- 4.2 (LTS, long-term support version)

See [https://endoflife.date/django](https://endoflife.date/django){target=\"_blank"} for
more information.

#### Python version

`djereo` (and its base, [pycliche](https://github.com/albertomh/pycliche){target=\"_blank"})
support Python 3.10 and above. The user's choice is recorded in a [.python-version](https://github.com/albertomh/djereo/blob/main/template/.python-version.jinja){target=\"_blank"}
file and in the `requires-python` field of [pyproject.toml](https://github.com/albertomh/djereo/blob/main/template/pyproject.toml.jinja){target=\"_blank"}.

See [https://endoflife.date/python](https://endoflife.date/python){target=\"_blank"} for
more information.

#### Postgres version

`djereo` is configured to work with a postgres database and contains utilities and checks
to help with this. See [Postgres database](#postgres-database) below for more information.

Note that it is trivial to switch from postgres to SQLite (a single-line change in `.env.in`)
if you prefer that database engine.

!!! note "Keeping versions consistent"
    The `django-version-checks` package is used to ensure all environments (local, CI, dev,
    prod) use the same versions of Python & postgres.

#### Semantic Versioning

The generated project follows Semantic Versioning, with users prompted to provide an
initial version at project setup. The project's version is tracked in the `version` field
of [pyproject.toml](https://github.com/albertomh/djereo/blob/main/template/pyproject.toml.jinja){target=\"_blank"}.

See [Release Please](#release-please) below for information on how this version can be used
alongside Conventional Commits to automatically generate changelogs and new semver tags.

See [https://semver.org/](https://semver.org/){target=\"_blank"} for more information.

<!-- markdownlint-disable MD013 line-length -->
## <img src="https://simpleicons.org/icons/precommit.svg" width="25" alt="pre-commit logo"> Git pre-commit hooks
<!-- markdownlint-enable MD013 line-length -->

Every new project comes with a set of sensible [pre-commit](https://pre-commit.com/){target=\"_blank"}
git hooks. These are defined in [.pre-commit-config.yaml](https://github.com/albertomh/djereo/blob/main/template/.pre-commit-config.yaml.jinja){target=\"_blank"}
and include:

- Common core hooks such as `check-merge-conflict` or `end-of-file-fixer`.
- `mypy` to perform static type checks on Python code.
- `asottile/pyupgrade` to convert syntax when the version of Python is upgraded.
- `astral-sh/ruff-pre-commit` to lint & format Python code at lightspeed with Ruff. Check
  the `tool.ruff.lint` table in `pyproject.toml` for a full list of rules and options.
- `DavidAnson/markdownlint-cli2` to lint markdown files with rules configured in [.markdownlint-cli2.yaml](https://github.com/albertomh/djereo/blob/main/template/.markdownlint-cli2.yaml){target=\"_blank"}.
- `biomejs/pre-commit` to lint & format frontend code (JS, TS, CSS) following config in [biome.jsonc](https://github.com/albertomh/djereo/blob/main/template/biome.jsonc){target=\"_blank"}.
- `adamchainz/djade-pre-commit` to format Django templates.
- `adamchainz/django-upgrade` to automatically migrate code to a new version of Django.
- `alessandrojcm/commitlint-pre-commit-hook` to enforce [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/){target=\"_blank"}.

<!-- markdownlint-disable MD013 line-length -->
## <img src="https://simpleicons.org/icons/github.svg" width="25" alt="GitHub logo"> Optional GitHub features
<!-- markdownlint-enable MD013 line-length -->

As part of the setup questionnaire users are asked whether the project they are creating
will be hosted on GitHub. If this is the case, GitHub Actions config files are added to
their project. The resulting custom actions and workflows are described below.

### Custom GitHub actions

Three re-usable custom actions are available:

- `pre-commit`: runs all pre-commit hooks except `no-commit-to-branch` as this would
   make merge pipelines fail. In workflows (see below) all jobs depend on this action
   succeeding.
- `sys-check`: runs Django's system checks (`manage.py check`).
- `test`: runs all unit tests via the `just test` recipe (see [Justfile](#-justfile) for
   details).

See [.github/actions/](https://github.com/albertomh/djereo/tree/main/template/%7B%25if%20is_github_project%25%7D.github%7B%25endif%25%7D/actions){target=\"_blank"}
for the definitions of these actions.

### GitHub Actions workflows

Four workflows are defined:

#### `PR` (pull request)

Runs whenever a pull request is opened against a branch or an existing PR receives new commits.

#### `CI` (continuous integration)

As with `PR`, but acts when a pull request is closed and changes merged into the `main` branch.

#### Release Please

Refreshes a pull request that updates the changelog & bumps the Semantic Version every
time the `main` branch is merged to.  
[.release-please-config.json](https://github.com/albertomh/djereo/blob/main/template/%7B%25if%20is_github_project%25%7D.release-please-config.json%7B%25endif%25%7D.jinja){target=\"_blank"}
configures the tool while [.release-please-manifest.json](https://github.com/albertomh/djereo/blob/main/template/%7B%25if%20is_github_project%25%7D.release-please-manifest.json%7B%25endif%25%7D.jinja){target=\"_blank"}
is the source of truth for the latest SemVer tag.

**N.B.** conventional commits (as enforced by the relevant git hook) are a prerequisite
for Release Please to generate changelogs and calculate new SemVer tags.

In order for Release Please to automate the above process, a GitHub Actions 'repository secret'
called `RELEASE_PLEASE_TOKEN` must exist in GitHub (under <repo>/secrets/actions).
The contents of this secret must be a Personal Access Token (PAT) with the following permissions:

```yaml
contents: write
pull-requests: write
```

For more information, consult the [release-please-action project](https://github.com/googleapis/release-please-action){target=\"_blank"}.

#### Dependabot

Configured to update Python dependencies & GitHub actions on a weekly schedule.

See [.github/workflows/](https://github.com/albertomh/djereo/tree/main/template/%7B%25if%20is_github_project%25%7D.github%7B%25endif%25%7D/workflows){target=\"_blank"}
and [.github/dependabot.yaml](https://github.com/albertomh/djereo/blob/main/template/%7B%25if%20is_github_project%25%7D.github%7B%25endif%25%7D/dependabot.yaml){target=\"_blank"}
for the definitions of these workflows.

## 🤖 Justfile

Four recipes are ready to use in every new project. Each takes care of setting up a
virtualenv and installing dependencies (including the project itself in editable mode).

- `manage`: wrapper around Django's `manage.py`. Takes one or more arguments, which
  defaults to 'help'.
- `runserver`: execute Django's `runserver` management command using Python in
  [Development Mode](https://docs.python.org/3/library/devmode.html){target=\"_blank"}.
  This mode shows additional warnings (Deprecation, Import, Resource) and enables extra
  debug hooks. Development Mode can be disabled by passing an empty string
  i.e. `just runserver ""`
- `shell`: run Django's management command to drop into a shell. By default this is IPython
  in all new projects.
- `test`: install test dependencies, run all unit tests via Django's test runner and
  generate and display a coverage report (both on-screen and in HTML format).

<!-- markdownlint-disable MD013 line-length -->
## <img src="https://simpleicons.org/icons/gnubash.svg" width="25" alt="GNU Bash logo"> Developer Experience enhancements
<!-- markdownlint-enable MD013 line-length -->

### Use IPython as your shell

`IPython`, an improved Python shell, is installed as a development dependency. Django picks
it up by default and uses it instead of the default Python shell. Access it directly with
the `just shell` recipe.

By default IPython's debugger (`ipdb`) will launch when a `breakpoint()` is reached while
running the application.
`ipdb` is also used to debug tests and will launch when a test fails. The file `.pdbrc`
contains aliases that can be used in `ipdb` debugger sessions.

### Developer tools

The project comes with some ready-to-use developer tools installed as dev dependencies and
configured for use locally:

- [django-browser-reload](https://pypi.org/project/django-browser-reload/){target=\"_blank"}:
  watch project files for changes and reload the browser.
- [django-debug-toolbar](https://pypi.org/project/django-debug-toolbar/){target=\"_blank"}:
  display information about the request/response cycle on each page.
- [rich](https://pypi.org/project/rich/){target=\"_blank"}: nicer formatting and colours
  for `runserver` logs.

### Custom system checks

`djereo` adds two custom system checks that run when the `check` management command is
invoked.

- `check_dev_mode`: alerts to the application running in debug mode yet Python's Development
  Mode not being enabled, indicating that there are some warnings and debug hooks you may
  be missing out on.
- `check_model_names`: enforces consistent model names across the application.

The `sys-check` GitHub action will run the default Django checks and the above custom
checks as part of the continuous integration pipeline.

While strictly speaking not a system test, the `django-linear-migrations` package is enabled
on all projects generated by `djereo`. This package updates a `max_migration.txt` file
whenever `makemigrations` runs, triggering a merge conflict if there is an attempt to apply
a non-linear migration history.

### Use project metadata in the Django app

`{{project_name}}/__init__.py` exposes project metadata such as version and author information.
To use it in a view:

```python
from django.http import HttpResponse

from {{project_name}} import __version__


def view(request):
    return HttpResponse(f"on version v{__version__}")
```

<!-- markdownlint-disable MD013 line-length -->
## <img src="https://simpleicons.org/icons/framework.svg" width="25" alt="cog logo"> settings.py
<!-- markdownlint-enable MD013 line-length -->

`settings.py` takes values for certain configuration options from environment variables,
managed via the `environs` package. When no values are specified, it falls back to sensible
defaults.

`settings.py` is divided into five sections:

- **Setup**  
  Settings such as determining whether the application is running under test conditions or
  defining the `BASE_DIR`.
- **Django Core Settings**  
  `INSTALLED_APPS` is defined by combining three lists containing apps according to their
  provenance. `LOGGING` is configured to use `rich` when DEBUG is True and `structlog`
  otherwise.
- **Django Contrib Settings**  
  [_left empty for the user to populate_]
- **Third Party Settings**  
  Settings for `django-allauth` and dev tools such as the debug toolbar and `django-version-checks`.
- **Project Settings**  
  [_left empty for the user to populate_]

The `tool.ruff.lint.flake8-tidy-imports.banned-api` table in `pyproject.toml` includes
configuration to have the `ruff` pre-commit hook enforce a ban on importing the `settings`
module directly. It suggests that you use `from django.conf import settings` instead as
this is safer and avoids complications if `override_settings` is used in tests.

<!-- markdownlint-disable MD013 line-length -->
## <img src="https://simpleicons.org/icons/googlemessages.svg" width="25" alt="message bubble"> Logging
<!-- markdownlint-enable MD013 line-length -->

Logging differs between hosted environments (eg. production) and development.

In development (`runserver`) [rich](https://pypi.org/project/rich/){target=\"_blank"} is
used to output coloured logs:

![runserver logs for a project generated using djereo](media/djereo_runserver-logs.png)

When `DEBUG=False`, as in production, [structlog](https://www.structlog.org/){target=\"_blank"}
is used instead.

Logging configuration is dynamically generated based on the `DEBUG` environment variable.
The `LoggingConfigFactory` class is used to generate settings for filters, formaters,
handlers and loggers.

## Models

The core app defines an `UuidModel` abstract model. Models that subclass it will have
a UUID as a primary key instead of the default `BigAutoField`. This is used by the models
in the existing 'users' app and can be used by any new models you create.

Utility abstract models `CreatedAtModel`, `UpdatedAtModel` and `DeletedAtModel` (for
soft-deletion) are available to store timestamps.

<!-- markdownlint-disable MD013 line-length -->
## <img src="https://simpleicons.org/icons/postgresql.svg" width="25" alt="postgres elephant logo"> Postgres database {#postgres-database}
<!-- markdownlint-enable MD013 line-length -->

`djereo` projects are configured to use a `postgres` database out-of-the-box.

This can easily be switched to use a SQLite database instead by changing a single line in
the dotenv template, `.env.in`.

### Set up & tear down scripts

The `_db/` directory contains the following database scripts:

- `set_up.sql` creates a postgres user and database with the same name as the project.
- `tear_down.sql` undoes `set_up.sql` and removes the database and user.

Django's default test database behaviour (creating a new database with a name formed by
prepending the name of the default database with `test_`) is left as-is.

### Database connection string

The database connection is configured in `settings.py` using the `environs` package's
'Django database URL' extension. That is, as a single database connection string that is
located in `.env` as the environment variable `DATABASE_URL`.

### `seed_database` management command

A `seed_database` management command is included for quickstart purposes and as a starting
point for you to populate with models needed for local development as your application grows.

In a new project `seed_database` creates three users: admin, staff and a non-privileged
regular user.

Invoke it with `just manage seed_database`.

<!-- markdownlint-disable MD013 line-length -->
## <img src="https://simpleicons.org/icons/monkeytie.svg" width="25" alt="fingerprint logo"> User authentication
<!-- markdownlint-enable MD013 line-length -->

Projects generated with `djereo` follow the 'custom User + UserProfile' pattern common in
modern Django apps. Authentication functionality is implemented via the [django-allauth](https://allauth.org/){target=\"_blank"}
package for simplicity and to ease future extensibility. A dedicated Django app, `users`,
centralises models, template overrides and configuration for auth-related features.

### `users` app model factories

Model factories for `AuthUser` and `UserProfile` are provided as a convenience. This includes
subfactories to keep tests lean. This means that in a test one may generate a fleshed-out
user with:

```python
from users.factories import UserProfileFactory  
from users.models import AuthUser

profile = UserProfileFactory()

assert isinstance(up.user, AuthUser)
```

<!-- markdownlint-disable MD013 line-length -->
## <img src="https://simpleicons.org/icons/htmx.svg" width="25" alt="HTMX logo"> Frontend
<!-- markdownlint-enable MD013 line-length -->

### Default pages & styling

Generated projects include a vendorised copy of [mvp.css](https://andybrewer.github.io/mvp/){target=\"_blank"}.
This is used to style the default welcome page and the templates used by `django-allauth`
for the pages under `/accounts/`.

#### Styling `django-allauth` templates

See the section on [Styling Existing Templates](https://docs.allauth.org/en/latest/common/templates.html#styling-the-existing-templates){target=\"_blank"}
in the `django-allauth` docs for instructions on doing so. Out of the box `djereo` keeps
changes minimal, only overriding `django-allauth`'s base template (`users/templates/allauth/layouts/base.html`).

## 🤝 Third-party packages

### whitenoise

[whitenoise](https://whitenoise.readthedocs.io/en/stable/){target=\"_blank"} is included
as a dependency. It is configured to serve static files using Brotli compression and add
unique hashes to filenames so that each version can be cached for a long time.

<!-- markdownlint-disable MD013 line-length -->
## <img src="https://simpleicons.org/icons/pytest.svg" width="25" alt="simple test tubes logo"> Tests
<!-- markdownlint-enable MD013 line-length -->

`djereo` projects come with all the tooling needed to get you writing tests quickly, as
well as a couple of tests ready out-of-the-box.

The `PendingMigrationsTests` class will fail if any model changes are not yet captured in
a migration, with the aim of negating the possibility of a deployment attempt that fails
due to missing migrations.

The `test_checks` module tests the custom Django system checks added by `djereo`.

To run these tests use the recipe `just test`, passing the same optional arguments you
would when using `manage.py test` e.g. `just test package.module`.

<!-- markdownlint-disable MD013 line-length -->
## <img src="https://simpleicons.org/icons/rocket.svg" width="25" alt="rocket icon"> Deployment
<!-- markdownlint-enable MD013 line-length -->

While `djereo` eschews Docker throughout development, the advantages of containerisation
for tagged, reproducible builds in hosted environments are evident.

The `_deploy/` directory of projects generated with `djereo` includes a Dockerfile that
uses the local development toolchain (the `uv` project manager) to containerise web
applications.

The Dockerfile runs pre-production steps, such as enabling bytecode compilation to trade a longer
installation time for faster start-up times, or running Django's `collectstatic` command.
The container's entrypoint runs [gunicorn](https://docs.gunicorn.org/en/latest/index.html){target=\"_blank"}
as the WSGI web server to make the Django application available.

The resulting container has been tested in production behind [nginx](https://nginx.org/en/docs/index.html){target=\"_blank"}
as the reverse proxy, with `gunicorn` as the WSGI web server. `nginx` configuration and
setting up SSL certificates is beyond the scope of `djereo`, but hopefully the Docker image
provides a head-start on deploying applications generated by `djereo`.

`gunicorn` is included as a dependency of all `djereo` projects. If you are interested in
using ASGI instead of WSGI, check out [uvicorn](https://www.uvicorn.org/).
